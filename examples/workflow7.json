{
    "main": {
      "steps": [
        {
          "call_greet1": {
            "call": "greet_visitor",
            "args": {
              "first_name": "Sherlock",
              "last_name": "Holmes"
            },
            "result": "output1"
          }
        },
        {
          "call_greet2": {
            "call": "greet_visitor",
            "args": {
              "first_name": "Ada",
              "last_name": "Lovelace",
              "country": "USA"
            },
            "result": "output2"
          }
        },
        {
          "check_incoming1": {
            "call": "check_incoming",
            "args": {},
            "result": "msgs"
          }
        },
        {
          "return_message": {
            "return": "${msgs}"
          }
        }
      ]
    },
    "check_incoming": {
      "steps": [
        {
          "init_val": {
            "assign": [
              {
                "messages": []
              },
              {
                "ids": []
              },
              {
                "friends_count": []
              },
              {
                "key": 0
              }
            ]
          }
        },
        {
          "check_messages": {
            "call": "http.get",
            "args": {
                "url": "http://172.18.80.1:3000/users"
            },
            "result": "incoming_messages"
          }
        },
        {
          "filter_messages": {
            "for": {
              "value": "message",
              "in": "${incoming_messages.body.users}",
              "steps": [
                {
                  "check_condition": {
                    "switch": [
                      {
                          "condition": "${len(message.friends) > 0}",
                          "next": "save_message"
                      }
                    ],
                    "next": "continue"
                  }
                },
                {
                  "save_message": {
                    "assign": [
                      {
                        "messages[key]": "${message.firstname + \" \" + message.lastname}"
                      },
                      {
                        "ids[key]": "${message.userId}"
                      },
                      {
                        "friends_count[key]": "${len(message.friends)}"
                      },
                      {
                        "key": "${key + 1}"
                      }
                    ]
                  }
                }
              ]
            }
          }
        },
        {
          "collect_val": {
            "assign": [
              {
                "info[\"fullname\"]": "${messages}"
              },
              {
                "info[\"id\"]": "${ids}"
              },
              {
                "info[\"friends_count\"]": "${friends_count}"
              }
            ]
          }
        },
        {
          "result_messages": {
            "return": "${info}"
          }
        }
      ]
    },
    "greet_visitor": {
      "params": [
        "first_name",
        "last_name",
        "country: England"
      ],
      "steps": [
        {
          "prepare_message": {
            "return": "${\"Hello \" + first_name + \" \" + last_name + \" from \" + country + \".\"}"
          }
        }
      ]
    }
}
